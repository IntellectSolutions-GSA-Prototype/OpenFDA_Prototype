/*! dangle - v1.0.0 - 2013-03-02
* http://www.fullscale.co/dangle
* Copyright (c) 2013 FullScale Labs, LLC; Licensed MIT */
angular.module("dangle").directive("fsDateHisto",[function(){"use strict";return{restrict:"E",scope:{onClick:"=",width:"=",height:"=",bind:"=",label:"@",field:"@",duration:"@",delay:"@",interval:"@"},link:function(e,t,n){var r={top:20,right:20,bottom:30,left:80},i=e.width||1280,s=e.height||300,o=n.label||"Frequency",u=n.class||"";i=i-r.left-r.right,s=s-r.top-r.bottom;var a=d3.time.scale().range([0,i]),f=d3.scale.linear().range([s,0]),l=d3.svg.axis().scale(a).orient("bottom"),c=d3.svg.axis().scale(f).orient("left"),h=d3.select(t[0]).append("svg").attr("preserveAspectRatio","xMinYMin").attr("viewBox","0 0 "+(i+r.left+r.right)+" "+(s+r.top+r.bottom)).append("g").attr("transform","translate("+r.left+","+r.top+")");h.append("g").attr("class","histo x axis "+u).attr("transform","translate(0,"+s+")").call(l),h.append("g").attr("class","histo y axis "+u).call(c).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".51em").style("text-anchor","end").text(o),e.$watch("bind",function(t){var r=e.duration||0,o=e.delay||0,p=e.field||n.bind.split(".").pop().toLowerCase(),d=e.interval||"day";if(t){t=t.entries||[];var v=i/t.length-2,m=864e5;switch(d.toLowerCase()){case"minute":m=6e4;break;case"hour":m=36e5;break;case"day":m=864e5;break;case"week":m=6048e5;break;case"month":m=263e7;break;case"year":m=3156e7}a.domain([d3.min(t,function(e){return e.time}),d3.max(t,function(e){return e.time})+m]),f.domain([0,d3.max(t,function(e){return e.count})]);var g=h.transition().duration(r),b=h.selectAll("rect").data(t,function(e){return Math.random()});b.enter().append("rect").attr("class","histo rect "+u).attr("cursor","pointer").attr("x",function(e){return a(e.time)}).attr("y",function(e){return s}).attr("width",v).transition().delay(function(e,t){return t*o}).duration(r).attr("height",function(e){return s-f(e.count)}).attr("y",function(e){return f(e.count)}),b.on("mousedown",function(t){e.$apply(function(){(e.onClick||angular.noop)(p,t.time)})}),b.exit().remove(),g.select(".x").call(l),g.select(".y").call(c)}},!0)}}}]);